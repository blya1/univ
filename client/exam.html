<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Помощник для экзамена</title>
    <link rel="stylesheet" href="/style.css">
</head>

<body>
    <div class="container" id="auth-check">
        <div id="not-authorized" style="display: none;">
            <h2>Требуется авторизация</h2>
            <p>Пожалуйста, войдите для доступа к помощнику.</p>
            <button onclick="window.location.href='/'">Войти</button>
        </div>
        <div id="authorized" style="display: none;">
            <h2>Помощник для экзамена</h2>
            <div id="clients"></div>
            <button onclick="logout()">Выйти</button>
        </div>
        <div id="disconnected-message">Пользователь отключился</div>
    </div>
    <script>
        let ws = new WebSocket('ws://univ-8ebo.onrender.com');
        let isAuthorized = false;
        let pendingMessages = [];

        ws.onopen = () => {
            console.log('exam.html: WebSocket connected');
            const token = localStorage.getItem('authToken');
            if (token) {
                ws.send(JSON.stringify({ type: 'verifyToken', token }));
            } else {
                showNotAuthorized();
            }
            ws.send(JSON.stringify({ role: 'exam' }));
        };

        ws.onmessage = (event) => {
            try {
                const response = JSON.parse(event.data);
                console.log('exam.html: Received message:', response);

                if (response.type === 'verifyTokenResponse') {
                    if (response.success) {
                        isAuthorized = true;
                        document.getElementById('authorized').style.display = 'block';
                        document.getElementById('not-authorized').style.display = 'none';
                        pendingMessages.forEach(msg => processMessage(msg));
                        pendingMessages = [];
                    } else {
                        showNotAuthorized();
                    }
                } else if (isAuthorized) {
                    processMessage(response);
                } else {
                    console.log('exam.html: Buffering message until authorized:', response);
                    pendingMessages.push(response);
                }
            } catch (error) {
                console.error('exam.html: Error parsing message:', error);
            }
        };

        ws.onerror = (error) => {
            console.error('exam.html: WebSocket error:', error);
        };

        ws.onclose = () => {
            console.log('exam.html: WebSocket closed, attempting reconnect in 5s');
            setTimeout(() => {
                ws = new WebSocket('ws://univ-8ebo.onrender.com');
                ws.onopen = () => {
                    console.log('exam.html: WebSocket reconnected');
                    const token = localStorage.getItem('authToken');
                    if (token) {
                        ws.send(JSON.stringify({ type: 'verifyToken', token }));
                    }
                    ws.send(JSON.stringify({ role: 'exam' }));
                };
            }, 5000);
        };

        function processMessage(response) {
            console.log('exam.html: Processing message:', response);
            if (response.type === 'initialState') {
                console.log('exam.html: Processing initialState:', response.screenshots);
                updateClients(response.screenshots);
            } else if (response.type === 'screenshot') {
                console.log('exam.html: Processing screenshot:', response);
                addScreenshot(response.clientId, response);
            } else if (response.type === 'answer') {
                updateAnswer(response.clientId, response);
            } else if (response.type === 'clientDisconnected') {
                showDisconnectedMessage(response.clientId);
            }
        }

        function showNotAuthorized() {
            document.getElementById('not-authorized').style.display = 'block';
            document.getElementById('authorized').style.display = 'none';
            setTimeout(() => {
                window.location.href = '/';
            }, 2000);
        }

        function logout() {
            const token = localStorage.getItem('authToken');
            if (token) {
                ws.send(JSON.stringify({ type: 'logout', token }));
            }
            localStorage.removeItem('authToken');
            window.location.href = '/';
        }

        function updateClients(screenshots) {
            console.log('exam.html: Updating clients with screenshots:', screenshots);
            const clientsDiv = document.getElementById('clients');
            clientsDiv.innerHTML = '';
            const clientMap = new Map();

            screenshots.forEach(s => {
                if (!clientMap.has(s.clientId)) {
                    clientMap.set(s.clientId, []);
                }
                clientMap.get(s.clientId).push(s);
            });

            clientMap.forEach((screenshots, clientId) => {
                console.log('exam.html: Creating client section for:', clientId);
                const clientSection = document.createElement('div');
                clientSection.className = 'client-section';
                clientSection.dataset.clientId = clientId;
                clientSection.innerHTML = `
                    <div class="client-header">
                        <button onclick="toggleQuestions(this)">Клиент ${clientId}</button>
                    </div>
                    <div class="questions"></div>
                `;
                clientsDiv.appendChild(clientSection);

                screenshots.forEach(s => {
                    addScreenshot(clientId, s);
                });
            });
        }

        function addScreenshot(clientId, data) {
            let clientSection = Array.from(document.getElementsByClassName('client-section')).find(section => {
                return section.dataset.clientId === clientId;
            });

            if (!clientSection) {
                console.log(`exam.html: Creating new client section for ${clientId}`);
                const clientsDiv = document.getElementById('clients');
                clientSection = document.createElement('div');
                clientSection.className = 'client-section';
                clientSection.dataset.clientId = clientId;
                clientSection.innerHTML = `
                    <div class="client-header">
                        <button onclick="toggleQuestions(this)">Клиент ${clientId}</button>
                    </div>
                    <div class="questions"></div>
                `;
                clientsDiv.appendChild(clientSection);
            }

            const questions = clientSection.querySelector('.questions');
            const questionDiv = document.createElement('div');
            questionDiv.className = `question ${data.answer ? '' : 'pending'}`;
            questionDiv.dataset.questionId = data.questionId;
            questionDiv.innerHTML = `
                <img src="${data.screenshot}" alt="Скриншот">
                <div class="answer-input">
                    <input type="text" placeholder="Введите ответ" value="${data.answer || ''}">
                    <button onclick="sendAnswer('${clientId}', '${data.questionId}')">Отправить</button>
                </div>
            `;
            questions.appendChild(questionDiv);
            questions.classList.add('visible');
            console.log(`exam.html: Added screenshot for client ${clientId}, question ${data.questionId}, URL length: ${data.screenshot.length}`);
        }

        function updateAnswer(clientId, data) {
            const questionDiv = Array.from(document.getElementsByClassName('question')).find(div => {
                return div.dataset.questionId === data.questionId && div.closest('.client-section').dataset.clientId === clientId;
            });
            if (questionDiv) {
                const input = questionDiv.querySelector('input');
                input.value = data.answer;
                // Убрали установку disabled
                questionDiv.classList.remove('pending');
                console.log(`exam.html: Updated answer for client ${clientId}, question ${data.questionId}`);
            }
        }

        function sendAnswer(clientId, questionId) {
            const questionDiv = Array.from(document.getElementsByClassName('question')).find(div => {
                return div.dataset.questionId === questionId && div.closest('.client-section').dataset.clientId === clientId;
            });
            if (!questionDiv) return;

            const answer = questionDiv.querySelector('input').value;
            ws.send(JSON.stringify({
                type: 'answer',
                clientId,
                questionId,
                answer,
                answeredBy: 'admin'
            }));
            console.log(`exam.html: Sent answer for client ${clientId}, question ${questionId}`);
        }

        function toggleQuestions(button) {
            const questions = button.parentElement.nextElementSibling;
            questions.classList.toggle('visible');
        }

        function showDisconnectedMessage(clientId) {
            const disconnectedMessage = document.getElementById('disconnected-message');
            disconnectedMessage.textContent = `Клиент ${clientId} отключился`;
            disconnectedMessage.style.display = 'block';
            setTimeout(() => {
                disconnectedMessage.style.display = 'none';
            }, 3000);
        }
    </script>
</body>

</html>
